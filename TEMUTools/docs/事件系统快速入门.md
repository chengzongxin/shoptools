# äº‹ä»¶ç³»ç»Ÿå¿«é€Ÿå…¥é—¨æŒ‡å—

## ğŸ¯ ç›®æ ‡

å½“ç½‘ç»œè¯·æ±‚å‘ç”Ÿ403é”™è¯¯æ—¶ï¼Œè‡ªåŠ¨é€šçŸ¥å¹¶åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„åŠŸèƒ½æ¨¡å—ä»»åŠ¡ã€‚

## âš¡ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥é›†æˆï¼‰

### ç¬¬1æ­¥ï¼šåœ¨ä½ çš„Crawlerç±»ä¸­æ·»åŠ åˆå§‹åŒ–ä»£ç 

```python
from ..network.event_manager import EventManager
import threading

class YourCrawler:
    def __init__(self):
        # ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
        
        # âœ… æ·»åŠ è¿™3è¡Œä»£ç 
        self.event_manager = EventManager()
        self.stop_event = threading.Event()
        self.event_manager.subscribe("config_error", self._handle_config_error)
```

### ç¬¬2æ­¥ï¼šæ·»åŠ é”™è¯¯å¤„ç†å‡½æ•°

```python
    def _handle_config_error(self, **kwargs):
        """å½“æ”¶åˆ°403é”™è¯¯é€šçŸ¥æ—¶ï¼Œè®¾ç½®åœæ­¢ä¿¡å·"""
        print(f"æ”¶åˆ°é…ç½®é”™è¯¯é€šçŸ¥ï¼Œåœæ­¢ä»»åŠ¡")
        self.stop_event.set()  # è®¾ç½®åœæ­¢ä¿¡å·
```

### ç¬¬3æ­¥ï¼šåœ¨å¾ªç¯ä¸­æ£€æŸ¥åœæ­¢ä¿¡å·

```python
    def process_items(self, items):
        """å¤„ç†é¡¹ç›®åˆ—è¡¨"""
        self.stop_event.clear()  # ä»»åŠ¡å¼€å§‹å‰æ¸…é™¤æ—§ä¿¡å·
        
        for item in items:
            # âœ… åœ¨æ¯æ¬¡å¾ªç¯æ—¶æ£€æŸ¥åœæ­¢ä¿¡å·
            if self.stop_event.is_set():
                print("ä»»åŠ¡å·²åœæ­¢")
                break
            
            # å¤„ç†é¡¹ç›®...
            result = self.request.post("/api/process", {"item": item})
```

## âœ¨ å®Œæˆï¼

å°±è¿™ä¹ˆç®€å•ï¼å½“ä»»ä½•åœ°æ–¹çš„ç½‘ç»œè¯·æ±‚å‘ç”Ÿ403é”™è¯¯æ—¶ï¼Œä½ çš„æ¨¡å—ä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥å¹¶åœæ­¢ã€‚

## ğŸ“š å®Œæ•´ç¤ºä¾‹

```python
from ..network.request import NetworkRequest
from ..network.event_manager import EventManager
import threading

class PriceReviewCrawler:
    """æ ¸ä»·æ¨¡å—ç¤ºä¾‹"""
    
    def __init__(self):
        self.request = NetworkRequest()
        
        # 1. åˆå§‹åŒ–äº‹ä»¶ç³»ç»Ÿ
        self.event_manager = EventManager()
        self.stop_event = threading.Event()
        self.event_manager.subscribe("config_error", self._handle_config_error)
    
    # 2. æ·»åŠ é”™è¯¯å¤„ç†å‡½æ•°
    def _handle_config_error(self, **kwargs):
        print(f"[æ ¸ä»·æ¨¡å—] æ”¶åˆ°é…ç½®é”™è¯¯é€šçŸ¥ï¼Œåœæ­¢ä»»åŠ¡")
        self.stop_event.set()
    
    # 3. åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ£€æŸ¥åœæ­¢ä¿¡å·
    def batch_review(self, products):
        self.stop_event.clear()  # å¼€å§‹å‰æ¸…é™¤
        
        for i, product in enumerate(products):
            if self.stop_event.is_set():  # æ£€æŸ¥åœæ­¢ä¿¡å·
                print(f"ä»»åŠ¡å·²åœæ­¢ï¼Œå·²å¤„ç† {i}/{len(products)}")
                break
            
            # å‘é€è¯·æ±‚
            result = self.request.post("/api/review", {"id": product.id})
            if result is None:
                # è¯·æ±‚å¤±è´¥ï¼Œå¦‚æœæ˜¯403é”™è¯¯ï¼Œstop_eventä¼šè¢«è‡ªåŠ¨è®¾ç½®
                continue
            
            # å¤„ç†ç»“æœ...
```

## ğŸ” å·¥ä½œåŸç†

```
1. ä½ çš„æ¨¡å—å¯åŠ¨ â”€â”€â†’ è®¢é˜… "config_error" äº‹ä»¶
2. ç½‘ç»œè¯·æ±‚å‘ç”Ÿ403 â”€â”€â†’ NetworkRequest å‘å¸ƒäº‹ä»¶
3. ä½ çš„æ¨¡å—æ”¶åˆ°é€šçŸ¥ â”€â”€â†’ è®¾ç½® stop_event
4. å¾ªç¯æ£€æµ‹åˆ°ä¿¡å· â”€â”€â†’ åœæ­¢ä»»åŠ¡
```

## ğŸ’¡ å…³é”®ç‚¹

1. **ä½¿ç”¨ `threading.Event()`** - çº¿ç¨‹å®‰å…¨çš„åœæ­¢ä¿¡å·
2. **è®¢é˜…ä¸€æ¬¡å³å¯** - åœ¨ `__init__` ä¸­è®¢é˜…
3. **ç»å¸¸æ£€æŸ¥** - åœ¨æ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶æ£€æŸ¥ `stop_event.is_set()`
4. **æ¸…é™¤ä¿¡å·** - æ¯æ¬¡ä»»åŠ¡å¼€å§‹å‰è°ƒç”¨ `stop_event.clear()`

## ğŸ“– æ›´å¤šä¿¡æ¯

- è¯¦ç»†è¯´æ˜ï¼šè§ `äº‹ä»¶é€šçŸ¥ç³»ç»Ÿä½¿ç”¨è¯´æ˜.md`
- ä»£ç ç¤ºä¾‹ï¼šè§ `event_system_example.py`

## â“ å¸¸è§é—®é¢˜

**Q: æˆ‘çš„æ¨¡å—æ²¡æœ‰Crawlerç±»æ€ä¹ˆåŠï¼Ÿ**  
A: åœ¨ä»»ä½•éœ€è¦åœæ­¢çš„ç±»ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚GUIç±»ã€‚

**Q: éœ€è¦æ‰‹åŠ¨è§¦å‘äº‹ä»¶å—ï¼Ÿ**  
A: ä¸éœ€è¦ï¼NetworkRequest åœ¨é‡åˆ°403é”™è¯¯æ—¶ä¼šè‡ªåŠ¨è§¦å‘ã€‚

**Q: å¯ä»¥è‡ªå®šä¹‰å…¶ä»–äº‹ä»¶å—ï¼Ÿ**  
A: å¯ä»¥ï¼ä½¿ç”¨ `event_manager.publish("ä½ çš„äº‹ä»¶å", å‚æ•°=å€¼)` å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶ã€‚

**Q: å½±å“æ€§èƒ½å—ï¼Ÿ**  
A: å‡ ä¹æ²¡æœ‰å½±å“ï¼Œåªæ˜¯ç®€å•çš„æ¡ä»¶åˆ¤æ–­ã€‚

